name: TypeScript Quality Assurance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  typescript-quality:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Install dependencies
      working-directory: ./backend
      run: npm ci
      
    - name: Generate Prisma Client
      working-directory: ./backend
      run: npm run prisma:generate
      
    - name: TypeScript Compilation Check
      working-directory: ./backend
      run: |
        echo "ðŸ” Running TypeScript compilation check..."
        npm run build
        echo "âœ… TypeScript compilation successful"
        
    - name: Type Coverage Analysis
      working-directory: ./backend
      run: |
        echo "ðŸ“Š Analyzing type coverage..."
        npx type-coverage --at-least 95 --strict --ignore-files "**/*.test.ts" --ignore-files "**/*.spec.ts"
        echo "âœ… Type coverage meets requirements"
        
    - name: ESLint Type Safety Rules
      working-directory: ./backend
      run: |
        echo "ðŸ” Running ESLint with TypeScript rules..."
        npx eslint --config .eslintrc.bulletproof.js "src/**/*.ts" --max-warnings 0
        echo "âœ… ESLint type safety checks passed"
        
    - name: TypeScript Strict Mode Validation
      working-directory: ./backend
      run: |
        echo "ðŸ” Validating strict TypeScript configuration..."
        node -e "
          const config = require('./tsconfig.json');
          const required = {
            strict: true,
            noImplicitAny: true,
            strictNullChecks: true,
            strictFunctionTypes: true,
            strictBindCallApply: true,
            strictPropertyInitialization: true,
            noImplicitReturns: true,
            noFallthroughCasesInSwitch: true,
            noUncheckedIndexedAccess: true,
            exactOptionalPropertyTypes: true
          };
          
          const missing = Object.entries(required).filter(([key, value]) => 
            config.compilerOptions[key] !== value
          );
          
          if (missing.length > 0) {
            console.error('âŒ Missing strict TypeScript settings:', missing);
            process.exit(1);
          }
          
          console.log('âœ… TypeScript strict configuration validated');
        "
        
    - name: Run Type Safety Tests
      working-directory: ./backend
      run: |
        echo "ðŸ§ª Running type safety validation tests..."
        npm test -- tests/type-safety.test.ts --verbose
        echo "âœ… Type safety tests passed"
        
    - name: Check for Any Types
      working-directory: ./backend
      run: |
        echo "ðŸ” Scanning for prohibited 'any' types..."
        if grep -r ": any" src/ --include="*.ts" --exclude-dir=node_modules; then
          echo "âŒ Found prohibited 'any' types in source code"
          exit 1
        fi
        
        if grep -r "as any" src/ --include="*.ts" --exclude-dir=node_modules; then
          echo "âŒ Found prohibited 'as any' type assertions"
          exit 1
        fi
        
        echo "âœ… No prohibited 'any' types found"
        
    - name: Check for Non-null Assertions
      working-directory: ./backend
      run: |
        echo "ðŸ” Scanning for prohibited non-null assertions..."
        if grep -r "!" src/ --include="*.ts" --exclude-dir=node_modules | grep -v "!==\|!=\|!req\|!process" | grep "\..*!"; then
          echo "âŒ Found prohibited non-null assertions (!) in source code"
          echo "Use type guards or getUserContext helper instead"
          exit 1
        fi
        
        echo "âœ… No prohibited non-null assertions found"
        
    - name: Validate Interface Completeness
      working-directory: ./backend
      run: |
        echo "ðŸ” Checking for incomplete interface implementations..."
        # This would be caught by TypeScript compilation, but let's be explicit
        npm run build 2>&1 | grep -i "does not implement\|missing implementation" && exit 1 || true
        echo "âœ… All interfaces properly implemented"
        
    - name: Prisma Schema Validation
      working-directory: ./backend
      run: |
        echo "ðŸ” Validating Prisma schema consistency..."
        npm run prisma:validate
        echo "âœ… Prisma schema validation passed"
        
    - name: Generate Type Coverage Report
      working-directory: ./backend
      run: |
        echo "ðŸ“Š Generating type coverage report..."
        npx type-coverage --details --output-dir ./coverage/type-coverage
        
    - name: Upload Type Coverage Report
      uses: actions/upload-artifact@v3
      with:
        name: type-coverage-report-${{ matrix.node-version }}
        path: backend/coverage/type-coverage/
        
    - name: Performance Test - Build Time
      working-directory: ./backend
      run: |
        echo "â±ï¸ Testing TypeScript build performance..."
        time npm run build > /dev/null
        echo "âœ… Build completed within acceptable time"
        
    - name: Code Quality Summary
      working-directory: ./backend
      run: |
        echo "ðŸ“‹ Code Quality Summary:"
        echo "âœ… Zero TypeScript compilation errors"
        echo "âœ… 95%+ type coverage achieved"
        echo "âœ… No 'any' types in source code"
        echo "âœ… No non-null assertions (!) used"
        echo "âœ… All interfaces fully implemented"
        echo "âœ… Strict TypeScript configuration enforced"
        echo "âœ… ESLint type safety rules passed"
        echo "âœ… Prisma schema validation passed"
        echo ""
        echo "ðŸŽ‰ TypeScript quality assurance completed successfully!"

  dependency-security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Security Audit
      working-directory: ./backend
      run: |
        echo "ðŸ”’ Running security audit..."
        npm audit --audit-level moderate
        echo "âœ… Security audit passed"
        
    - name: Check for Outdated Dependencies
      working-directory: ./backend
      run: |
        echo "ðŸ“¦ Checking for outdated dependencies..."
        npm outdated || true  # Don't fail on outdated deps, just report
        
  integration-test:
    needs: typescript-quality
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_DB: impact_bot_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Install dependencies
      working-directory: ./backend
      run: npm ci
      
    - name: Setup Test Database
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://postgres:test@localhost:5432/impact_bot_test
      run: |
        npm run prisma:generate
        npm run prisma:push
        
    - name: Run Integration Tests
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://postgres:test@localhost:5432/impact_bot_test
        NODE_ENV: test
      run: |
        echo "ðŸ§ª Running integration tests with type safety validation..."
        npm test
        echo "âœ… Integration tests passed"